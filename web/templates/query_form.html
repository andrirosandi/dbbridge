{{define "query_form"}}
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">

<h2>{{if .IsEdit}}Edit{{else}}New{{end}} Query</h2>
<form method="POST" action="/admin/queries/save">
    {{if .IsEdit}}
    <input type="hidden" name="id" value="{{.Query.ID}}">
    {{end}}

    <label for="slug">Slug (URL endpoint)</label>
    <input type="text" id="slug" name="slug" value="{{.Query.Slug}}" required placeholder="e.g. get-customer-by-id">

    <label for="description">Description</label>
    <input type="text" id="description" name="description" value="{{.Query.Description}}"
        placeholder="Fetch customer details">

    <label for="sql_text">SQL Query</label>
    <textarea id="sql_text" name="sql_text" rows="5" required
        placeholder="SELECT * FROM users WHERE id = :id">{{.Query.SQLText}}</textarea>
    <small>Use <code>:param_name</code> for parameters.</small>

    <div style="margin-top: 1rem;">
        <label>Allowed Connections</label>
        <div class="grid" style="grid-template-columns: 1fr; gap: 20px;">
            {{range .Connections}}
            <div class="connection-item" style="border: 1px solid #ccc; padding: 10px; border-radius: 5px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <label style="margin-bottom: 0;">
                        <input type="checkbox" name="connection_ids" value="{{.ID}}" {{if $.IsEdit}} {{range
                            $.Query.AllowedConnectionIDs}} {{if eq . $.ID}}checked{{end}} {{end}} {{end}}>
                        {{.Name}} ({{.Driver}})
                    </label>
                    <button type="button" class="outline" onclick="runQuery({{.ID}}, 'result-{{.ID}}')"
                        style="width: auto; padding: 5px 15px; font-size: 0.8rem;">
                        â–¶ Run
                    </button>
                </div>
                <!-- Result Container -->
                <div id="result-{{.ID}}" style="margin-top: 10px; overflow-x: auto; display: none;"></div>
            </div>
            {{end}}
        </div>
        <small>Select which databases this query can be executed against.</small>
    </div>

    <div style="margin-top: 1rem;">
        <label for="is_active">
            <input type="checkbox" id="is_active" name="is_active" {{if or (not .IsEdit)
                .Query.IsActive}}checked{{end}}>
            Active
        </label>
    </div>

    <div class="grid" style="margin-top: 2rem;">
        <button type="submit">Save Query</button>
        <a href="/admin/queries" role="button" class="secondary">Cancel</a>
        {{if .IsEdit}}
        <a href="/admin/queries/delete?id={{.Query.ID}}" role="button" class="contrast"
            onclick="return confirm('Are you sure?')">Delete</a>
        {{end}}
    </div>
</form>

<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>
<script>
    var editor = CodeMirror.fromTextArea(document.getElementById("sql_text"), {
        mode: "text/x-sql",
        theme: "dracula",
        lineNumbers: true,
        matchBrackets: true,
        indentWithTabs: true,
        smartIndent: true,
        lineWrapping: true
    });
    editor.setSize(null, 400); // Height

    async function runQuery(connID, resultDivID) {
        const sql = editor.getValue();
        const resultDiv = document.getElementById(resultDivID);

        if (!sql) {
            alert("Please enter a SQL query first.");
            return;
        }

        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<small>Running...</small>';

        try {
            const formData = new FormData();
            formData.append('connection_id', connID);
            formData.append('sql_text', sql);

            const response = await fetch('/admin/queries/run', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || "Unknown error");
            }

            // Render Table
            if (!data.rows || data.rows.length === 0) {
                resultDiv.innerHTML = '<small>No results found or query executed successfully.</small>';
                return;
            }

            let html = '<table role="grid" style="font-size: 0.8rem;"><thead><tr>';
            data.columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';

            data.rows.forEach(row => {
                html += '<tr>';
                data.columns.forEach(col => {
                    html += `<td>${row[col] !== null ? row[col] : '<em>NULL</em>'}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';

            resultDiv.innerHTML = html;

        } catch (e) {
            resultDiv.innerHTML = `<small style="color: red;">Error: ${e.message}</small>`;
        }
    }
</script>
{{end}}