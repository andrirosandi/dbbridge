{{define "query_form"}}
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">

<h2>{{if .IsEdit}}Edit{{else}}New{{end}} Query</h2>
<form method="POST" action="/admin/queries/save">
    {{if .IsEdit}}
    <input type="hidden" name="id" value="{{.Query.ID}}">
    {{end}}

    <label for="slug">Slug (URL endpoint)</label>
    <input type="text" id="slug" name="slug" value="{{.Query.Slug}}" required placeholder="e.g. get-customer-by-id">

    <label for="description">Description</label>
    <input type="text" id="description" name="description" value="{{.Query.Description}}"
        placeholder="Fetch customer details">

    <label for="sql_text">SQL Query</label>
    <textarea id="sql_text" name="sql_text" rows="5" required
        placeholder="SELECT * FROM users WHERE id = :id">{{.Query.SQLText}}</textarea>
    <small>Use <code>{param_name}</code> for parameters.</small>

    <details
        style="margin-top: 10px; background-color: var(--card-sectionning-background-color); padding: 10px; border-radius: var(--border-radius);">
        <summary><strong>Variable Dictionary / Cheat Sheet</strong></summary>
        <p>You can use the following dynamic variables in your SQL:</p>
        <ul style="font-size: 0.9em;">
            <li><code>{param}</code> - Standard parameter. User will be prompted to enter a value.</li>
            <li><code>{status:active}</code> - Parameter with <strong>default value</strong> 'active'.</li>
            <li><code>{pagination}</code> - Adds <code>LIMIT/OFFSET</code> logic automatically. Controls
                <code>_page</code> and <code>_limit</code>.
            </li>
            <li><code>{pagination:1:20}</code> - Pagination with custom default (Page 1, Limit 20).</li>
            <li><code>{pagination::100}</code> - Pagination with default Limit 100.</li>
            <li><code>{ids}</code> - Arrays/Lists are supported! <code>IN ({ids})</code> expands automatically to
                <code>IN (?, ?, ?)</code>.
                <ul>
                    <li><strong>UI Input:</strong> Type as JSON string: <code>[1, 2, 3]</code> or
                        <code>["a", "b"]</code>
                    </li>
                    <li><strong>API JSON:</strong> Send as actual array: <code>"ids": [1, 2, 3]</code></li>
                </ul>
            </li>
        </ul>
        <small><strong>Note:</strong> JSON body parameters <code>_page</code> and <code>_limit</code> override
            defaults.</small>
    </details>

    <div style="margin-top: 1rem;">
        <label>Allowed Connections</label>
        <div class="grid" style="grid-template-columns: 1fr; gap: 10px;">
            <table role="grid">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Connection</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Connections}}
                    {{$connID := .ID}}
                    <tr>
                        <td>
                            <input type="checkbox" name="connection_ids" value="{{.ID}}" {{if $.IsEdit}} {{range
                                $.Query.AllowedConnectionIDs}} {{if eq . $connID}}checked{{end}} {{end}} {{end}}>
                        </td>
                        <td>
                            {{.Name}} <small>({{.Driver}})</small>
                        </td>
                        <td>
                            <button type="button" class="outline" onclick="runQuery({{.ID}}, '{{.Name}}')"
                                style="width: auto; padding: 5px 15px; font-size: 0.8rem;">
                                â–¶ Run
                            </button>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        <small>Select which databases this query can be executed against.</small>
    </div>

    <div style="margin-top: 1rem;">
        <label for="is_active">
            <input type="checkbox" id="is_active" name="is_active" {{if or (not .IsEdit)
                .Query.IsActive}}checked{{end}}>
            Active
        </label>
    </div>

    <div class="grid" style="margin-top: 2rem;">
        <button type="submit">Save Query</button>
        <a href="/admin/queries" role="button" class="secondary">Cancel</a>
        {{if .IsEdit}}
        <a href="/admin/queries/delete?id={{.Query.ID}}" role="button" class="contrast"
            onclick="return confirm('Are you sure?')">Delete</a>
        {{end}}
    </div>
</form>

<hr />

<!-- Global Result Container -->
<div id="query-result-section" style="display: none; margin-top: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 id="result-header" style="margin-bottom: 0;">Query Result</h3>
        <!-- Pagination Controls -->
        <div id="pagination-controls" style="display: none; gap: 10px; align-items: center;">
            <button type="button" class="outline" onclick="changePage(-1)" id="btn-prev" disabled>Previous</button>
            <span id="page-indicator">Page 1</span>
            <button type="button" class="outline" onclick="changePage(1)" id="btn-next">Next</button>
            <small style="margin-left: 10px;">(Limit: <span id="limit-indicator">50</span>)</small>
        </div>
    </div>
    <div id="global-result" style="overflow-x: auto;"></div>
</div>

<!-- Params Modal -->
<dialog id="params-modal">
    <article>
        <h3>Enter Parameters</h3>
        <p>This query requires the following parameters:</p>
        <form id="params-form">
            <div id="modal-inputs" class="grid" style="grid-template-columns: 1fr; gap: 10px;">
                <!-- Inputs generated via JS -->
            </div>
            <footer>
                <a href="#cancel" role="button" class="secondary" onclick="closeModal()">Cancel</a>
                <a href="#confirm" role="button" id="confirm-run">Run Query</a>
            </footer>
        </form>
    </article>
</dialog>

<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>
<script>
    var editor = CodeMirror.fromTextArea(document.getElementById("sql_text"), {
        mode: "text/x-sql",
        theme: "dracula",
        lineNumbers: true,
        matchBrackets: true,
        indentWithTabs: true,
        smartIndent: true,
        lineWrapping: true
    });
    editor.setSize(null, 400); // Height

    // Modal Elements
    const modal = document.getElementById('params-modal');
    const modalForm = document.getElementById('params-form');
    const modalInputs = document.getElementById('modal-inputs');
    let currentConnID = null;
    let currentConnName = "";
    let lastParams = {}; // Store last used params for pagination re-runs

    // Result Elements
    const resultSection = document.getElementById('query-result-section');
    const resultHeader = document.getElementById('result-header');
    const resultDiv = document.getElementById('global-result');

    // Pagination Elements & State
    const paginationControls = document.getElementById('pagination-controls');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');
    const pageIndicator = document.getElementById('page-indicator');
    const limitIndicator = document.getElementById('limit-indicator');

    let currentPage = 1;
    let currentLimit = 50;
    let isPaginationActive = false;

    function closeModal() {
        modal.open = false;
    }

    async function runQuery(connID, connName) {
        const sql = editor.getValue();
        if (!sql) {
            alert("Please enter a SQL query first.");
            return;
        }

        // Reset Pagination State
        currentPage = 1;
        currentLimit = 50; // Default Global
        isPaginationActive = false;

        // Check for Pagination Syntax to Initialize Defaults
        // Regex: {pagination} or {pagination:P:L}
        const pagRegex = /\{\s*pagination(?::\s*(\d*)\s*:\s*(\d*)\s*)?\}/;
        const pagMatch = pagRegex.exec(sql);
        if (pagMatch) {
            isPaginationActive = true;
            // Parse defaults from SQL if present
            // pagMatch[1] = page, pagMatch[2] = limit
            if (pagMatch[1]) {
                const p = parseInt(pagMatch[1]);
                if (!isNaN(p) && p > 0) currentPage = p;
            }
            if (pagMatch[2]) {
                const l = parseInt(pagMatch[2]);
                if (!isNaN(l) && l > 0) currentLimit = l;
            }
        }

        // 1. Detect Params using Regex matching ParseResult logic
        // Exclude pagination matching
        const regex = /\{\s*((?!pagination)[a-zA-Z0-9_]+)(?::([^}]+))?\s*\}/g;
        let match;
        const params = new Map();

        while ((match = regex.exec(sql)) !== null) {
            const name = match[1];
            const defFull = match[2] ? match[2].trim() : "";
            if (!params.has(name) || (defFull !== "" && params.get(name) === "")) {
                params.set(name, defFull);
            }
        }

        if (params.size > 0) {
            currentConnID = connID;
            currentConnName = connName;

            modalInputs.innerHTML = '';
            params.forEach((defaultValue, param) => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label for="param-${param}">${param}</label>
                    <input type="text" id="param-${param}" name="${param}" value="${defaultValue}" required>
                `;
                modalInputs.appendChild(div);
            });

            modal.open = true;
            return;
        }

        // No params, run directly
        executeRun(connID, connName, {});
    }

    // Pagination Handler
    function changePage(delta) {
        if (!isPaginationActive) return;
        const newPage = currentPage + delta;
        if (newPage < 1) return;

        currentPage = newPage;
        executeRun(currentConnID, currentConnName, lastParams);
    }

    // Handle Modal Submit via Button
    document.getElementById('confirm-run').addEventListener('click', (e) => {
        e.preventDefault();
        submitModal();
    });

    // Handle Enter key in Modal Form
    modalForm.addEventListener('submit', (e) => {
        e.preventDefault();
        submitModal();
    });

    function submitModal() {
        // Collect params
        const params = {};
        const inputs = modalInputs.querySelectorAll('input');
        let valid = true;
        inputs.forEach(input => {
            if (!input.value) valid = false;
            params[input.name] = input.value;
        });

        if (!valid) {
            alert("Please fill all parameters");
            return;
        }

        closeModal();
        executeRun(currentConnID, currentConnName, params);
    }

    async function executeRun(connID, connName, params) {
        currentConnID = connID; // Ensure updated for pagination
        currentConnName = connName;
        lastParams = { ...params }; // Copy params for pagination re-runs

        const sql = editor.getValue();

        resultSection.style.display = 'block';
        resultHeader.innerText = `Query Result (Connection: ${connName})`;
        resultDiv.innerHTML = '<div aria-busy="true">Running query...</div>';

        // Update Pagination UI
        if (isPaginationActive) {
            paginationControls.style.display = 'flex';
            pageIndicator.innerText = `Page ${currentPage}`;
            limitIndicator.innerText = currentLimit;
            btnPrev.disabled = currentPage <= 1;

            // Inject _page and _limit
            params['_page'] = currentPage;
            params['_limit'] = currentLimit;
        } else {
            paginationControls.style.display = 'none';
        }

        // Scroll (optional, maybe annoying if clicking next/prev repeatedly)
        // resultSection.scrollIntoView({ behavior: 'smooth' });

        try {
            // Use JSON for params support
            const payload = {
                connection_id: parseInt(connID),
                // Query ID might be in .Query.ID if injected, but here we are in a JS function.
                // We need to access the input hidden field "id" if it exists.
                query_id: document.querySelector('input[name="id"]') ? parseInt(document.querySelector('input[name="id"]').value) : 0,
                sql_text: sql,
                params: params
            };

            const response = await fetch('/admin/queries/run', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || "Unknown error");
            }

            // Render Table
            if (!data.rows || data.rows.length === 0) {
                resultDiv.innerHTML = '<small>No results found.</small>';
                return;
            }

            let html = '<table role="grid" style="font-size: 0.8rem;"><thead><tr>';
            data.columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';

            data.rows.forEach(row => {
                html += '<tr>';
                data.columns.forEach(col => {
                    html += `<td>${row[col] !== null ? row[col] : '<em>NULL</em>'}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';

            resultDiv.innerHTML = html;

        } catch (e) {
            resultDiv.innerHTML = `<article style="background-color: #ffe6e6; color: #cc0000; border: 1px solid #cc0000;"><strong>Error:</strong> ${e.message}</article>`;
        }
    }
</script>
{{end}}